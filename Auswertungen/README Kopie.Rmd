---
output: rmarkdown::github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

# hystReet

[![Project Status: Active – The project has reached a stable, usable state and is being actively developed.](http://www.repostatus.org/badges/latest/active.svg)](http://www.repostatus.org/#active)


```{r setup, include=FALSE, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE,
                      comment = "##",
                      fig.retina = 2,
                      fig.align = "center",
                      fig.path = "README_figs/README-")
Sys.setlocale("LC_TIME", "C")
```

## Introduction

[hyperstreet](https://hystreet.com) is a companie collecting pedestrains in german cities. After registering you can download the data for free from 19 cities.

Here we present the analysis of five different locations.

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(readr)
library(lubridate)
library(scales)
```


## API Keys

Installing and using civis requires an API key. Instructions for creating an API key can be found here. All API keys have a set expiration date and so a new key will need to be created at least every 30 days.

Once you have created an API key, you will then need to add it to your .Renviron so the civis package can access it.

Linux/MacOS
touch ~/.Renviron
open -t ~/.Renviron
Then add the following line replacing the fake key sadf8sadf9jasdf with the API key from your Civis Platform Profile:

CIVIS_API_KEY=sadf8sadf9jasdf
After saving the .Renviron file, you'll need to restart R/Rstudio.

Windows
A .Renviron file can be created in the R user home directory, Sys.getenv("R_USER"). Typically this is "C:/username/Documents". Open or create .Renviron with notepad and add the key as above. Save with type all files, not .txt. Restart R/Rstudio.

❗️ You must keep your API key secret. If you use version control tools, ensure you do not commit .Renviron or any scripts in which you have hard-coded an API key.

## Usage

First we load the data and prepare the data with [dplyr](https://www.tidyverse.org).

```{r}

files <- list.files("data/")

data <- lapply(files, function(x){

  read_delim(file = paste0("data/",x), delim = ";",
                   col_types = list(
                     col_character(),
                     col_character(),
                     col_integer())) %>% 
  mutate(time_of_measurement = ymd_hms(time_of_measurement) + hours(2)) 
  
}) %>% 
  bind_rows() %>% 
mutate(day = day(time_of_measurement),
       weekday = wday(time_of_measurement, label = TRUE),
       year = year(time_of_measurement),
       month = month(time_of_measurement),
       month_label = month(time_of_measurement, TRUE),
       monthweek = ceiling(day(time_of_measurement) / 7),
       day = day(time_of_measurement),
       hour = hour(time_of_measurement),
       minute = minute(time_of_measurement),
       date = dmy(paste0(day, ".", month, ".",year)),
       time = strftime(time_of_measurement, format = "%H:%M"))
```

## Analysis

Let´s see if we can see the weekends before christmas. Nice how to see the build up from Monday to Saturday :-)

```{r}
g <- ggplot(data %>% 
              filter(month == 12,
                     location %in% c("Neuhauser Straße", 
                                     "Schildergasse (West)", 
                                     "Georgstraße", 
                                     "Westenhellweg",
                                     "Königstraße (Mitte)")) %>% 
              group_by(day, date, location) %>% 
              summarise(sum = sum(counted_pedestrians)), 
            aes(x = date, y = sum, fill = location)) +
  geom_bar(position = "dodge", stat = "identity") +
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Date", y = "Pedestrians")+
  scale_x_date(date_breaks = "3 days")

plot(g)
```

## Further results

Now a more comprehensive analysis with a new dimension: the time per day. Due to the fact that the data provide information every 15 minutes, we can analyse this timeseries too.

```{r}
g <- ggplot(data %>% 
              filter(location %in% c("Neuhauser Straße", 
                                     "Schildergasse (West)", 
                                     "Georgstraße", 
                                     "Westenhellweg",
                                     "Königstraße (Mitte)"),
                     date != dmy("17.12.2018")), 
            
            aes(monthweek, location, fill = counted_pedestrians,frame = time)) +
  geom_tile(colour = "white") + 
  facet_grid(weekday~month_label) + 
  scale_fill_gradient(low = "yellow", high = "red")
```

```{r, eval = FALSE}
library(gganimate)

animation::ani.options(ani.width = 800, ani.height = 600)


## note: This process can take a long time!
gganimate(g, interval = 0.25, filename = "Pedestrians_hystReet.gif")
```

<img src="README_figs/Pedestrians_hystReet.gif" width="960" />

